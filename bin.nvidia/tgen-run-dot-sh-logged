#!/bin/sh

csh-p || exit 1

source script-x
set -u
progname="$(basename $0)"
source eexec
eexec_program=$(EExec_parse "$@")
for op in $eexec_program
do
  $op
  shift
done
unset eexec_program

EExecVerbose

: ${p4_clib_dir:=//hw/ap_tlit1/clib/Linux}
: ${log_file_base_name:=dot-sh}
# I'm done with bash because the quoting sucks beyond suckage:
# --egrep 'ERROR: cannot aquire /tmp/asim.X'
# --egrep 'something bad happened'}
# --cflush-every=-1 --> flush to zip every line.
: ${teeker_options=--slog -Z9 --ts --hg -i100 --cflush-every=-1}
: ${testname=}

check_test()
{
    local testname="$@"
    local rc=1

    echo "Checking test candidate>$@<"
    if [ -z "${testname}" ]
    then
        echo 'testname is empty'
    elif (($(echo "$@" | wc -w) > 1))
    then
        echo "More than one executable file found."
    elif test -d "${testname}"
    then
        echo "${testname} is a dir."
    elif ! test -x "${testname}"
    then
        echo "${testname} is not executable."
    else
        rc=0
    fi
    return "$rc"
}

if vunsetp "${testname}"
then
    case "${1-}" in
        -|.|--) shift;;
        -*|"") ;;
        *) testname="${1}"; shift ;;
    esac
    vunsetp "${testname}" && {
        # In a dir like:
        # /home/scratch.dpanariti_t124_1/sb3/sb3hw/hw/ap_t132/diag/testgen/dp-run-tgens.d/swr_so_runlimit/2013-08-16T18.26.17-0400.out/tests/kepler_b_ogtest/00/00/01/000001
        testname=$(pwd | sed -rn 's!(^.*/dp-run-tgens.d/)([^/]+)(/.*)!\2!p')
        #echo_id testname
        vsetp "${testname}" && testname="${testname}.sh"
        if ! check_test "$testname"
        then
            testname=$(ls -1 *.sh | egrep -v '^(command|.*\.cmd)\.sh$')
            #echo_id testname
            if ! check_test "${testname}"
            then
                echo "$progname: No test name given and cannot guess a good default.
Usage:  testname [additional-teeker-options]"
                exit 1
            fi 1>&2
        fi
        echo "Deduced test name>${testname}<"
    }
fi
test_base_name=$(basename "${testname}" .sh)
cfg_file_name="${test_base_name}.cfg"
so_name=$(sed -rn "s/(.*-plugin ')([^[:space:]]+)( .*)/\2/p" "${cfg_file_name}").so
#echo_id so_name
clib_dir=$(me-expand-dest "${p4_clib_dir}")
so_path="${clib_dir}/${so_name}"
#echo_id so_path
# Check for no go&^@*(#amn(*#&(#*&$other-*&^#*$&-ing link errors.
ldd "${so_path}"
#echo "Finish writing ldd check!"

# E.g. ./surface_write_read_no_smmu_bar1.sh 2>&1 | teeker --slog -Z9 --ts --grep 'surface_write_read:' --hg dot-sh --egrep 'ERROR: cannot aquire /tmp'; email-yopp

EExec "${testname}" 2>&1 | EExec teeker ${teeker_options} "$@" "${log_file_base_name}"
rc="$?"
EExec email-yopp "$progname: \"${testname} $@\" is done. RC: $rc"
