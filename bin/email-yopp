#!/bin/sh

source script-x
set -u
progname="$(basename $0)"
source eexec
eexec_program=$(EExec_parse "$@")
for op in $eexec_program
do
  $op
  shift
done
unset eexec_program

: ${annotation=}
: ${run_cmd_p=}
RC=-

while (($# > 0))
do
  case "$1" in
      --cron) annotation="cron: ${annotation}";;
      --anno|--annotation) shift; annotation="${annotation} ${2}";;
      --run|--exec|--eval|--cmd) run_cmd_p=t;;
      --rc|--RC) shift; RC="${1}";;
      --) shift; break;;
      *) break;
  esac
  shift
done

if vunsetp "$*"
then
    type="No msg."
elif true_p "${run_cmd_p}"
then
    # the message is really a command to run and wait for completion thereof.
    EExec --keep-going "$@"
    RC="$?"
    type="CMD[RC: $?]: "
else
    type="MSG: "
fi

# HOW?!
# RC: -: YOPP! email-yopp: in /home/scratch.dpanariti_nvgpu/sb8/sb8hw/hw/nvgpu: MSG: dp4-sync: RC: 0
prefix="RC: ${RC}: "
msg="$progname: in ${PWD}: ${type}$@"

{
    echo "On $(date)"
    echo "${msg}"
} | EExec mail -s "${prefix}${annotation}YOPP! ${msg}" "${USER}"
