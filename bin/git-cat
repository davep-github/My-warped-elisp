#!/bin/sh

source script-x

git_diff_or_cat()
{
    local commit="$1"; shift
    local file="$1"; shift
    # This will, by default, cat its 2nd parameter, the name of the temp file
    # extracted from the given commit by git for doing the diff.
    export GIT_EXTERNAL_DIFF=$HOME/bin/dp-cat-some
    # sadly git doesn't seem to invoke the diff program if the files are
    # identical.
    if git diff "$commit" -- "$file" | grep -q .
    then
        git diff "$commit" -- "$file"
    else
        # The files are identical, so show the existing one.
        cat "$file"
    fi
}

nth=
commit="$1"; shift
case "$commit" in
    -n) nth="${commit}"; shift;;
    -n?*) nth=$(echo "$commit" | sed -rn 's/^(-n)([0-9]*)/\2/p');;
    -[0-9]*) nth=$(echo "$commit" | sed -rn 's/^(-)([0-9]*)/\2/p');;
    *);;
esac


[ -z "$*" ] && {
    echo 1>&2 "Usage: git-cat commit file+"
    exit 1
}
for f in "$@"
do
  if [ -n "$nth" ]
  then
      commit=$(git-nth-rev "$nth" "$f")
  fi
  git_diff_or_cat "$commit" "$f"
done
