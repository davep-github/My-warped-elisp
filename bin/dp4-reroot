#!/bin/sh

source script-x
set -u
progname="$(basename $0)"

verify_p=

[ "${1-}" = "-v" ] && {
    verify_p=t
    shift
}

if [ -n "$*" ]
then
    workspace=${1}
    shift
else
    workspace="."
fi
if [ "$workspace" = "." ]
    then
    workspace=$(dp4-get-root)
fi
case "$workspace" in
    */);;
    *) workspace="$workspace"/;;
esac

[ -n "$verify_p" ] && {
    [ -d "$workspace" ] || {
        echo "Workspace>$workspace< is not a dir."
        exit 1
    } 1>&2
}

reroot_one()
{
    local p="${1}"
    local justp=$(echo "${p}" | sed -r 's/([^#]+)(#.*$)/\1/')
    local newp=$(echo "$justp" | sed -r "s|^//|${workspace}|")
    [ -n "$verify_p" ] && {
        [ -e "$newp" ] || {
            echo "ERROR: Rerooted file>$newp< does not exist."
            exit 1
        } 1>&2
    }
    echo "$newp"
}

rc=0

if [ -z "$*" ]
then
    while read
    do
      reroot_one "$REPLY}"
    done
else
    for p in "$@"
    do
      reroot_one "${p}"
    done
fi

exit $rc
