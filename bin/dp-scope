#!/bin/bash
#
# Simple interface to cscope -l|-L line oriented interface.
# Mainly allow mnemonic names for fields.
# 0: Find this C symbol:
# 1: Find this global definition:
# 2: Find functions called by this function:
# 3: Find functions calling this function:
# 4: Find this text string:
# 5: Change this text string:
# 6: Find this egrep pattern:
# 7: Find this file:
# 8: Find files #including this file:

source script-x
set -u
progname="$(basename $0)"
source eexec
if vsetp "${eexec_program-}"    # Did the caller provide a program?
then
    EEXEC_SHIFT=:
else
    eexec_program=$(EExec_parse "$@")
    EEXEC_SHIFT=shift
fi

for op in $eexec_program
do
  $op
  ${EEXEC_SHIFT}
done
EExec_verbose_msg $(echo_id eexec_program)
unset eexec_program
# Or export eexec_program to propagate eexec info to a called program.
# export eexec_program

: ${EXTAGTREE_DASH_Q:=}
: ${POST_PROCESSOR:=post_format}

field_num=0
arg=${1-}

: ${find_up_p=t}
: ${db_finder_file=cscope.out}
: ${db_files=()}

while (($# > 0))
do
  case "$1" in
      --sym|--symbol|--cs|-s|--function) shift; arg="${1}"; field_num=0;;
      --global|--def|--definition|--global-def|--global-definition) shift; arg="${1}"; field_num=1;;
      --called|--called-by) shift; arg="${1}"; field_num=2;;
      --calling|--callers|--calls) shift; arg="${1}"; field_num=3;;
      --raw) POST_PROCESSOR=post_raw;;
      --format|--gcc|--grep) POST_PROCESSOR=post_format;;
      -t|--text|--str|--string|--text-string|--text-str|--txt) shift; arg="${1}"; field_num=4;;
      --change|--change-text|--change-txt) field_num=5;;  # This may require more work.
      --egrep|--grep|--regexp|--re) shift; arg="${1}"; field_num=6;;
      --file) shift; arg="${1}"; field_num=7;;
      --db-file) shift; db_files=("${1}");;
      --add-db-file) shift; db_files+=("${1}");;
      -a|--all-db-files) db_files=( $(index-locations) );;
      -i|--including|--include|--inc|-h|--includes) field_num=8;;
      --find-up|--fup) find_up_p=t;;
      --use-dot|--dot-only|--no-find-up) find_up_p=;;
      --) shift; break;;
      *) break;;
  esac
  shift
done

# ((${#db_files[@]-0} == 0)) || vsetp "${find_up_p}" || {
#     # look for a cscope db above us.
#     EExec_verbose_msg "finding up"
#     db_files=($(find-up "${db_finder_file}"))
# }
db_files=($(find-up "${db_finder_file}"))

EExec_verbose_msg "db_files[@]>${db_files[@]-}<"

perverted_index_option=-q
[ -e "cscope.po.out" ] || {
    perverted_index_option=
}
set -- "$@" "${arg}" ${perverted_index_option}

[ -z "$*" ] && {
    echo "No arguments were provided. Thanks for playing."
    exit 1
} 1>&2

if ((${#db_files[@]} == 0))
then
    EExec ${DP_CSCOPE_PROGRAM-cscope} -d ${EXTAGTREE_DASH_Q} -L -"${field_num}" "$@"
    exit
fi

post_raw()
{
    cat
}

post_format()
{
    # Sigh. No $<fnum0>...$<fnumN>.
    awk '{printf "%s:%d\t ", $1, $3; $1=$2=$3=""; print $0}'
}

for db_file in "${db_files[@]}"
do
    EExec -0 ${DP_CSCOPE_PROGRAM-cscope} -d ${EXTAGTREE_DASH_Q} \
        -f"${db_file}" -L -"${field_num}" "$@" | "${POST_PROCESSOR}"
done  
