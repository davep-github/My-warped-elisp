#!/bin/sh
# $Id: dogo,v 1.4 2005/02/09 09:20:09 davep Exp $
#set -x

. script-x 

SHIFT=shift

fini()
{
    o_val="$*$two"
    echo $o_val
    [ "$o_val" = "$argWas" ] && exit 1
    exit 0
}

go_lookup()
{
    c="$1"; shift
    gPath=${GOPATH-$HOME/.go}
    oldIFS=$IFS
    IFS=":"
    for pathEl in $gPath # search all files in the GOPATH
    do
      [ -f "$pathEl" ] && {
          IFS=$oldIFS
          # tmp=`egrep "(^|[^#;])|$c|" $pathEl` && { tmp=$(egrep -v
          # '^[[:space:]]*[;#]' $pathEl | fgrep $show_dir_opt "|$c|") && {
          # When -m1 is used, the fgrep can exit before the egrep resulting
          # in a pipe error.
          tmp=$(egrep -v '^[[:space:]]*[;#]' $pathEl 2>/dev/null | fgrep -m1 $show_dir_opt "|$c|") && {
              set -- $tmp
              $SHIFT
              eval echo "$*$cs"
              return
          }
      }
    done
    IFS=$oldIFS
    echo "$argWas"
}

for o in "$@"
do
  case "$1" in
      -l) show_dir_opt="-l"; SHIFT=:;;
      -L) shift; fini $(go_lookup "$1"); exit;;
      *) break;;
  esac
  shift
done

argWas="$1"
two="$2"

case "$two" in
    ""|/*) ;;
    */) two="/$two"
esac

case "$1" in
    /*)  fini "$1"; exit 0;;
    */*) c=$(echo "$1" | sed -n 's!^\([^/]*\).*$!\1!p')
         cs=$(echo "$1" | sed -n 's!^[^/]*/*\(.*\)$!\1!p')
         ;;
    *) c="$1"; cs='';;
esac

# see if dest is set as an environment variable
[ -z "$show_dir_opt" ] && eval y=\$$c 
case "$y" in
    ""|\$*)     # dest is not an envvar: look it up in the go database
    case "$c" in
        back|b) fini ${GoBack-$HOME} ;;
        "") fini . ; exit ;;
        *) fini $(go_lookup "$c") ;;
    esac ;;

    *) eval fini "$y$cs" ; exit ;;
esac

