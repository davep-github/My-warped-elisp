#!/bin/sh
# Make a new perforce sandbox.

source script-x
progname="$(basename $0)"
source eexec

askForConfirmation=
revision=

: ${work_dir:=.}
: ${sync_p=}
: ${DASH_N_OPT=}
: ${P4CONFIG=.p4config}
: ${client_template=${DP_P4_CLIENT_TEMPLATE}}
: ${P4PORT=}
: ${P4DIFF=}

tmp_file=                # Needs to be non-null so at_exit() is less brittle.

at_exit()
{
    [ -n "$tmp_file" ] && rm -f "$tmp_file"
}

# We need a shared directory if editing across machines.
# p4 help environment lists both TMP and TEMP, but I don't know which one has
# priority if both are set.
export TMP=$HOME/tmp
export TEMP=$TMP

Usage_synopsis="Make a new perforce(tm) sandbox under work dir [$work_dir] 
  and optionally populate it."
Usage_args_info=" <sandbox a.k.a client-name>"

EExecVerbose
std_options=""
option_str="anvqw:sr:.t:Ty"
long_options=("port:" "diff:")

DPGOP_args_required=t
source dp-getopt+.sh || exit 1

for i in "$@"
do
  # do. e.g.  $OPTION_ARG=$2; shift;; to process options with arguments.
  case $1 in
      -a) EExecAsk=t;;
      -n) DASH_N_OPT=-n; EXEC=echo; EExecDashN;; # Don't actually execute stuff
      -v) VERBOSE="echo $progname: "; EExecVerbose;;
      -q) VERBOSE=":"; EExecQuiet;;
      -w) work_dir=$2; shift;;
      -s) sync_p=t;;
      -r) revision="$2"; shift;;
#      -.) sandbox_name=$(scsandbox -.);;
      -.) sandbox_name=$(basename $PWD);;
      -t) shift; client_template="$1";;
      -T) client_template=;;
      -y) do_it_anyway_p=-y;;
      --port) shift; P4PORT="${1}";;
      --diff) shift; P4DIFF="${1}";;
      # Help!
      --help) Usage; exit 0;;
      --) shift ; break ;;
      *) 
      echo 1>&2 "Unsupported option>$1<";
      Usage
      exit 1 ;;
    esac
    shift
done

: ${sandbox_name:=${1-}}
shift
[ -z "$sandbox_name" ] && {
    read -e -p "I need a sandbox name: " sandbox_name
}

${do_it_anyway_p=}

EExec cd $work_dir

[ -d "$sandbox_name" ] && {
    echo "sandbox \`$sandbox_name' already exists."
    exit 1
} 1>&2

EExec ${do_it_anyway_p} mkdir -p $sandbox_name
EExec ${do_it_anyway_p} cd $sandbox_name

#mk.p4client $DASH_N_OPT -c
: ${tmp_file:=$(mktemp -p ~/tmp dp4-new-clientXXXXX)}
client_name=$(dp4-mk-client-name)
(
    export PORT_DEFAULT="${P4PORT}"
    export DIFF_DEFAULT="${P4DIFF}"
    EExec -y dp4-mk-config "${client_name}" >| $tmp_file
    EExecVerbose_p && {
        echo_id tmp_file
        cat "${tmp_file}"
        echo "------"
    } 1>&2
)
EExec /bin/cp -f $tmp_file $P4CONFIG
EExec rm -f $tmp_file

template_opt=
[ -n "$client_template" ] && template_opt="-T $client_template"

EExec dp4-client $template_opt

rc=
if [ "$sync_p" == 't' ]
then
    EExec p4 sync $revision
    rc=$?
    echo 1>&2 "p4 sunk"
else
    true
fi
rc=$?
echo 1>&2 "Finished creating sandbox $sandbox_name."
exit $?
