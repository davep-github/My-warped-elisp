#!/usr/bin/env bash
#set -x
#set -v

echo "\$@>$@<"
prog=`basename $0`
echo $prog: $* 1>&2

# xcscope/cscope, have been having problems with "File does not have the
# expected format" errors. Not using -q has, at least once, in at least one
# case, fixed this.
##: ${DASH_Q=-q}
: ${DASH_Q=-q}
source script-x
source  eexec

args=("$@")                     # Preserve args across .bashrc execution.

tagtree()
{
    local files_file="$1"; shift
    local tag_file=${1-$TAGFILE}
    eval EExec $SUDO $EXCTAGS $inheritance_opt $etags_opt -L "$files_file" \
      --links=no -o $tag_file \
      $h_OPT $langmap $full_member_names "$py_props" "${EC_XARGS}"
}

cscope_tree()
{
    local files_file="$1"
    cs=$(sp -1 cscope)
    vunsetp $cs && cs=$(sp -1 dp-cscope)
    if vunsetp $cs
        then
        echo 1>&2 "Cannot find a cscope program."
    else
        EExec $cs $DASH_Q -b -i "$files_file" $cscope_flags
    fi
}

# {gentoo|libranet}'s default sudo define SECURE_PATH and so our binaries
# are inaccessible.
if [[ "$PATH" != *yokel/sbin* ]]
then
    rcfile="$HOME/.bashrc"
    [ -f $rcfile ] && . $rcfile
fi

#
# specify some extra options for exuberant ctags
#
: ${EXCTAGS:=exctags}
: ${EMACS_OPT:=-e}
: ${SUDO=}
: ${NOTAGFILE=NOTAG}
: ${EC_ARGS='--links=no'}
: ${EC_XARGS=''}
: ${FPAT='.*'}
: ${v:=''}
: ${FILES_FILE:=cscope.files}
: ${ETAGFILE:=TAGS}
: ${CTAGFILE:=tags}
: ${EXCLUDED_FILES_FILE:="extagtree.excluded-files"}
: ${DEF_SYSTEM_INCLUDES:="/usr/include"}
: ${src_code_finder:=find-src-code-files}
: ${use_id=t}
: ${finder_opts=}
: ${use_files_file_p=}
: ${cscope_p=t}
: ${etag_p=t}
: ${ctag_p=}


SYSTEM_INCLUDES=
###
# This stuff is really now in ~/bin/find-src-code-files
#: ${INTERESTING_FILES:="\.h|\.([chly](xx|pp)?|cs|cc|hh|py|pl|pm)$"}
#: ${FILES_OF_INTEREST:=$INTERESTING_FILES}
###

filter()
{
    egrep -e "${FPAT}" | \
    egrep -i -e "$FILES_OF_INTEREST"
}

inheritance_opt=

if [ -n "$v" ]
then
    v_file="/dev/tty"
else
    v_file="/dev/null"
fi
v=

set -- "${args[@]}"

for i in $*
do
    case $1 in
        -i) inheritance_opt="--fields=+i";;
        -n) EExecDashN; finder_opts="$finder_opts $1";;
        -v) EExecVerbose; finder_opts="$finder_opts $1";;
	-s) SUDO=sudo;;
	-t) tag_args="$tag_args $2"; shift;;
	-T) tag_args="$2 $tag_args"; shift;;
        -p) FPAT=$2; finder_opts="$finder_opts $1 $2"; shift;;
        -h) follow_sym_links="-h"; finder_opts="$finder_opts $1";;
        -I) SYSTEM_INCLUDES=$DEF_SYSTEM_INCLUDES;;
        -f) finder_opts="$finder_opts $2"; shift;;
        -r) use_files_file_p=$FILES_FILE;;
        -R) shift; use_files_file_p=$1;;
        -C) cscope_p=;;
        -T) etag_p=; ctag_p=;;
        -e) etag_p=t;;
        -c) ctag_p=t;;
	--) shift ; break ;;
	*) 
            break ;;
	    #echo 1>&2 "Unsupported option>$1<";
	    #exit 1 ;;
    esac
    shift
done

dirs="$@"
# Put the system includes first so any collisions will be noticeable.
dirs="$SYSTEM_INCLUDES $dirs"

#if true_p "$ETAGS_P"; then
#    etags_opt="-e"
#    TAGFILE=$ETAGFILE
#else
#    etags_opt=""
#    TAGFILE=$CTAGFILE
#fi

#
# specify some extra options for exuberant ctags
#
#why were these duped down here???# : ${EXCTAGS:=exctags}
#why were these duped down here???# : ${TAGFILE:=TAGS}
#why were these duped down here???# : ${SUDO:=}
#why were these duped down here???# : ${NOTAGFILE:=NOTAG}

if [[ -n "$EXCLUDED_FILES_FILE" && "$EXCLUDED_FILES_FILE" == "-" ]]; then
        EXCLUDED_FILES_FILE=""
fi
EXCLUDED_FILES_FILE_OPT=
[[ -n "$EXCLUDED_FILES_FILE" ]] && {
    EXCLUDED_FILES_FILE_OPT="-c $EXCLUDED_FILES_FILE"
}

# wha...
for tag_prog in exctags ctags-exuberant exuberant-ctags ctags dp-last-resort-ctags
do
    EXCTAGS=$(sp -1 $tag_prog)
    [ -n "$EXCTAGS" ] && {
	[[ "$EXCTAGS" = */ctags ]] && {
            echo -n 1>&2 "$prog: Found simply ctags. "
            if "$EXCTAGS" --help 2>&1 | fgrep -qi "Exuberant" 2>/dev/null
            then
                echo 1>&2 "It looks Exuberant!"
            else
                echo 1>&2 "$prog: May not be exuberant."
            fi
	}
	break
    }
done

if [ -z "$EXCTAGS" ]
then
    FATAL "cannot find exuberant ctags executable"
    exit 1
else
    echo "tagger: \`$EXCTAGS'"
fi

#
if [ -r $HOME/.ctags -o -r $HOME/.exctags ]
then
    h_OPT=
    langmap=
    full_member_names=
else
    # tell tagger that .inl files are headers.
    h_OPT='-h +.inl'
    langmap='--langmap=c++:+.inl.tcc.h-py'
    full_member_names='--extra=+q'
    py1="'--regex-python=/[ \t]*([_A-Za-z][_A-Za-z0-9]*)[ \t]*=[ \t]*property/\1/'"
    py2="'--regex-python=/^([A-Z_][A-Z0-9_]).*=/\1/'"
    py_props="$py1 $py2"
fi

# List of directories in which to look for source files.
argses="$@"
: ${argses:="."}

#CO# {
#CO#     echo "EXCLUDED_FILES_FILE>$EXCLUDED_FILES_FILE<"
#CO#     echo "EXCLUDED_FILES_FILE_OPT>$EXCLUDED_FILES_FILE_OPT<"
#CO# } 1>&2

# ftreewalk.py -X NOTAG \
#     $EXCLUDED_FILES_FILE_OPT \
#     $follow_sym_links $dirs | \
#     filter | tee $v_file >| "$FILES_FILE"

if [ -n "$use_files_file_p" ]
then
    if [ -s "$use_files_file_p" ]
    then
        FILES_FILE="$use_files_file_p"
        echo "Using files file: $FILES_FILE"
    else
        {
            echo "$use_files_file_p doesn't exist or is empty."
            echo "Will find files and put them in $use_files_file_p."
        } 1>&2
        FILES_FILE=$use_files_file_p
        use_files_file_p=
    fi
fi

if [ -z "$use_files_file_p" ]
then
    ${src_code_finder} $finder_opts $argses | tee "$v_file" >| "$FILES_FILE"
    chmod a-w "$FILES_FILE"
fi
[ -s "$FILES_FILE" ] || {
    echo "Cound not find any files. $FILES_FILE is empty."
} 1>&2

TAGFILES=()
[ -n "$etag_p" ] && {
    TAGFILE="$ETAGFILE"
    TAGFILES+=($TAGFILE)
    (
        # subshell
        etags_opt="-e"
        tagtree "$FILES_FILE" "$TAGFILE"
    ) &
}

[ -n "$ctag_p" ] && {
    TAGFILE="$CTAGFILE"
    TAGFILES+=($TAGFILE)
    (
        # subshell
        etags_opt=""
        tagtree "$FILES_FILE" "$TAGFILE"
    ) &
}

if [ -n "$use_id" ] && type mkid >/dev/null 2>&1
then
    prunes=$(untagged-dirs $argses)
    #echo_id prunes
    EExec mkid $prunes &
fi

[ -n "$cscope_p" ] && {
    cscope_tree "$FILES_FILE" &
}

echo "waiting for procs to complete..."
wait

if vsetp "$SUDO"
then
    EExec $SUDO chown $(id -u) "${TAGFILES[@]}"
else
    true
fi
