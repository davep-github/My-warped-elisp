#!/bin/sh
source script-x
progname="$(basename $0)"
source eexec

# Use my teeker program which saves stdin into a file like tee, but simply
# ticks off chars to stdout using tikker. Makes for a lot less output but
# gives feedback that something is happening.
teekerer()
{
    EExec -y teeker $teeker_opts "$@"
}

teekerer_sample()
{
    EExec -y teeker -s -i $teeker_interval "$@"
}

teeer()
{
    EExec -y tee "$@"
}

: ${save_args_p=t}
: ${save_args_at_root_p=t}
: ${save_args_here=}
tee_func=teekerer
teeker_opts=
teeker_interval=100
std_options=""
option_str="nvqtsk:i:"
long_options=("teeker-opts:" "tee:" "teeker-interval:"
    "no-save-args"
    "save_args_here:"
    "no-save-args-at-root")

source dp-getopt+.sh
for i in "$@"
do
  # do. e.g.  shift; $OPTION_ARG=$1;; to process options with arguments.
  case $1 in
      -n) EXEC=echo; EExecDashN;; # Don't actually execute stuff
      -v) VERBOSE="echo $progname: "; EExecVerbose;;
      -q) VERBOSE=":"; EExecQuiet;;
      -t) tee_func=teeer;;
      -k|--teeker-opts) shift; teeker_opts="$1";;
      -i|--teeker-interval) shift; teeker_interval="$1";;
      --no-save-args) save_args_p=;;
      --no-save-args-at-root_p) save_args_at_root_p=;;
      --save_args_here) shift; save_args_here="$1"; save_args_p=t;;
      --tee) shift; tee_func="$1";;
      --) shift ; break ;;
      *) 
      echo 1>&2 "Unsupported option>$1<";
      Usage
      exit 1 ;;
    esac
    shift
done

: ${kwa_log_dir:=$(scsandbox --root $PWD)}
: ${kwa_log_base:=dp4-sync-}
: ${kwa_log_name:=${kwa_log_dir}/${kwa_log_base}$(dp-std-timestamp)}
EExec -y mkdir -p "${kwa_log_dir}"

# print log name before and after in case it is a long sync.
echo "log file>${kwa_log_name}<"
[ -n "$save_args_p" ] && {
    [ -z "$save_args_here" ] && {
        if [ -n "$save_args_at_root_p" ]
        then
            save_args_here=$(depth)  # nVIDIA specific.
        else
            save_args_here="${kwa_log_dir}"
        fi
    }
    echo_id save_args_here
    EExec mkdir -p "${save_args_here}"
    save_args_file="${save_args_here}/dp4-sync-args"
    echo_id save_args_file
    echo "p4 sync args:
$@" >| "${save_args_file}"
}
EExec p4 sync "$@" 2>&1 | $tee_func "${kwa_log_name}"
echo "log in>${kwa_log_name}<"
# Let me know if anything needs merging.
EExec p4 resolve -n | $tee_func -a "${kwa_log_name}"
exit 0
