#!/bin/sh

#source script-x

# These were clobbering each other across hosts.
SSH_AGENT_RC="$HOME/.ssh/acmds.$HOSTNAME"
SSH_AGENT_RC_STDERR="${SSH_AGENT_RC}.stderr"
export SSH_AGENT_RC_umask=0077
export SSH_AGENT_RC_STDERR_umask=${SSH_AGENT_RC_umask}

dp_add_default_keys()
{
    ssh-add -l > /dev/null 2>&1
    local rc=$?
    case "$rc" in
        0) true;;               # Got some, hopefully all, default keys.
        1) ssh-add;;            # Agent up, no keys. Add defaults.
        *) false;;              # No agent
    esac
}

# Really start or connect to ssh agent
dp_start_ssh_agent()
{
#    env | fgrep SSH
    # See if there's a running agent to which we are attached.
    dp_add_default_keys && return 0

    # See if we can attach to one started elsewhere.
    [ -e "$SSH_AGENT_RC" ] && {
        # Use last set of agent variables.
        source "$SSH_AGENT_RC" || return 3
        # Try to add keys.
        dp_add_default_keys && return 0
    }
    # There isn't an agent already running that we can use, neither
    # configured in this shell nor one whose configuration info is in the
    # "$SSH_AGENT_RC"
    # So start one and save the configuration variables.
    ssh-agent | \fgrep -v echo >| "$SSH_AGENT_RC"
    # set those variables.
    source "$SSH_AGENT_RC" || return 3
    # If we can't set the keys, we're doomed.
    # Pass on the key command rc.
    dp_add_default_keys
}

[ -n "${runme-}" -o "$(basename -- $0)" = dp-ssh-agent ] && {
    dp_start_ssh_agent
}

